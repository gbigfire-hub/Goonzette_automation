name: Upload PDF to Netlify

on:
  # Run after PDF compilation completes
  workflow_run:
    workflows: ["Daily Article Generation and PDF Compilation"]
    types:
      - completed
  
  # Manual trigger
  workflow_dispatch:

jobs:
  upload-pdf:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Find latest daily PDF
        id: find-pdf
        run: |
          LATEST_PDF=$(ls -t pdfs/goonzette-daily-*.pdf 2>/dev/null | head -1 || echo "")
          
          if [ -z "$LATEST_PDF" ]; then
            echo "‚ö†Ô∏è  No daily PDF found to upload"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "found=true" >> $GITHUB_OUTPUT
          echo "pdf_path=$LATEST_PDF" >> $GITHUB_OUTPUT
          echo "pdf_name=$(basename $LATEST_PDF)" >> $GITHUB_OUTPUT
          echo "üìÑ Found PDF: $LATEST_PDF"
      
      - name: Download current Netlify site
        if: steps.find-pdf.outputs.found == 'true'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          echo "üì• Downloading current site from Netlify..."
          
          # Get the current published deploy ID
          DEPLOY_ID=$(curl -s -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            "https://api.netlify.com/api/v1/sites/$NETLIFY_SITE_ID" | \
            jq -r '.published_deploy.id')
          
          echo "Current deploy ID: $DEPLOY_ID"
          
          # Download the current site
          curl -H "Authorization: Bearer $NETLIFY_AUTH_TOKEN" \
            "https://api.netlify.com/api/v1/deploys/$DEPLOY_ID/files" \
            -o site.zip
          
          # Extract it
          unzip -q site.zip -d current-site || mkdir -p current-site
          
          echo "‚úÖ Site downloaded"
      
      - name: Add PDF to site
        if: steps.find-pdf.outputs.found == 'true'
        run: |
          PDF_PATH="${{ steps.find-pdf.outputs.pdf_path }}"
          PDF_NAME="${{ steps.find-pdf.outputs.pdf_name }}"
          
          echo "üìÑ Adding $PDF_NAME to site..."
          
          # Create pdfs directory if it doesn't exist
          mkdir -p current-site/pdfs
          
          # Copy the new PDF
          cp "$PDF_PATH" "current-site/pdfs/$PDF_NAME"
          
          echo "‚úÖ PDF added to site files"
      
      - name: Deploy updated site
        if: steps.find-pdf.outputs.found == 'true'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          PDF_NAME="${{ steps.find-pdf.outputs.pdf_name }}"
          
          echo "üì§ Deploying updated site to Netlify..."
          
          # Install Netlify CLI
          npm install -g netlify-cli
          
          # Deploy the complete site (with new PDF added)
          netlify deploy \
            --dir=current-site \
            --prod \
            --auth="$NETLIFY_AUTH_TOKEN" \
            --site="$NETLIFY_SITE_ID" \
            --message="Add daily PDF: $PDF_NAME"
          
          echo "‚úÖ Site deployed successfully!"
          echo "üìç PDF available at: https://the-goonzette.netlify.app/pdfs/$PDF_NAME"
      
      - name: Cleanup
        if: always()
        run: |
          rm -rf current-site site.zip

